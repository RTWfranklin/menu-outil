<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Menu en ligne</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Firebase v8 SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <link rel="stylesheet" href="menu-style.css" />
</head>
<body>
  <div id="menu"></div>
  <script>
    var firebaseConfig = {
      apiKey: "AIzaSyCxVS6IvetneJ1Q5kr8t5d7F3qd8oe8KjQ",
      authDomain: "menu-outil.firebaseapp.com",
      projectId: "menu-outil",
      storageBucket: "menu-outil.appspot.com",
      messagingSenderId: "659889655771",
      appId: "1:659889655771:web:c970fa451635dac4dfe1fe",
      measurementId: "G-18ZGPKGBQD"
    };
    firebase.initializeApp(firebaseConfig);
    var db = firebase.firestore();

    var params = new URLSearchParams(window.location.search);
    var menuId = params.get('id');
    var uid = params.get('uid');
    var menuDiv = document.getElementById('menu');

    if (!menuId || !uid) {
      menuDiv.innerHTML = "<div class='menu-error'>Menu introuvable</div>";
    } else {
      // Skeleton loading
      menuDiv.innerHTML = `
        <div class="skeleton-menu">
          <div class="skeleton-banner"></div>
          <div class="skeleton-header"></div>
          <div class="skeleton-categories">
            <div class="skeleton-card"></div>
            <div class="skeleton-card"></div>
            <div class="skeleton-card"></div>
          </div>
        </div>
      `;
      db.collection('users').doc(uid).collection('menus').doc(menuId).get().then(function(doc) {
        if (!doc.exists) {
          menuDiv.innerHTML = "<div class='menu-error'>Menu introuvable</div>";
          return;
        }
        var menu = doc.data();
        var html = "";
        // Bannière
        if (menu.banner) {
          html += '<div class="menu-banner"><img src="' + menu.banner + '" alt="Bannière"></div>';
        }
        // Logo & titre
        html += '<div class="menu-header">';
        if (menu.logo) {
          html += '<div class="menu-logo"><img src="' + menu.logo + '" alt="Logo"></div>';
        }
        html += '<h1 class="menu-title">' + (menu.title || "") + '</h1>';
        html += '</div>';
        // Barre de navigation catégories
        html += '<nav class="cat-nav">';
        (menu.categories || []).forEach(function(cat, idx) {
          html += '<button class="cat-nav-btn" data-catidx="'+idx+'">' + cat.name + '</button>';
        });
        html += '</nav>';
        // Catégories
        html += '<div class="menu-categories">';
        (menu.categories || []).forEach(function(cat, idx) {
          html += '<section class="menu-category" id="cat-'+idx+'">';
          html += '<h2 class="category-title">' + cat.name + '</h2>';
          if (cat.subcategories && cat.subcategories.length > 0) {
            cat.subcategories.forEach(function(subcat) {
              html += '<h3 class="subcategory-title" style="margin:18px 0 6px 0;font-size:1.07em;color:#555;font-weight:500">' + subcat.name + '</h3>';
              html += '<div class="category-items">';
              (subcat.items || []).forEach(function(item) {
                html += '<div class="menu-item-card">';
                if (item.img) {
                  html += '<div class="item-img"><img src="' + item.img + '" alt="' + item.name + '"></div>';
                }
                // Badges
                if (item.badges && item.badges.length) {
                  html += '<div class="item-badges">';
                  item.badges.forEach(function(badge) {
                    html += '<span class="item-badge" data-badge="' + badge + '">' + badge + '</span>';
                  });
                  html += '</div>';
                }
                html += '<div class="item-info">';
                html += '<span class="item-name">' + item.name + '</span>';
                if (item.desc) html += '<div class="item-desc">' + item.desc + '</div>';
                if (item.price) html += '<span class="item-price">' + item.price + '</span>';
                html += '</div>';
                html += '</div>';
              });
              html += '</div>';
            });
          } else {
            html += '<div class="category-items">';
            (cat.items || []).forEach(function(item) {
              html += '<div class="menu-item-card">';
              if (item.img) {
                html += '<div class="item-img"><img src="' + item.img + '" alt="' + item.name + '"></div>';
              }
              if (item.badges && item.badges.length) {
                html += '<div class="item-badges">';
                item.badges.forEach(function(badge) {
                  html += '<span class="item-badge" data-badge="' + badge + '">' + badge + '</span>';
                });
                html += '</div>';
              }
              html += '<div class="item-info">';
              html += '<span class="item-name">' + item.name + '</span>';
              if (item.desc) html += '<div class="item-desc">' + item.desc + '</div>';
              if (item.price) html += '<span class="item-price">' + item.price + '</span>';
              html += '</div>';
              html += '</div>';
            });
            html += '</div>';
          }
          html += '</section>';
        });
        html += '</div>';
        menuDiv.innerHTML = html;
        // Navigation fluide et surbrillance catégorie active
        var navBtns = document.querySelectorAll('.cat-nav-btn');
        var catSections = document.querySelectorAll('.menu-category');
        navBtns.forEach(function(btn, idx) {
          btn.addEventListener('click', function() {
            document.getElementById('cat-'+idx).scrollIntoView({ behavior: 'smooth', block: 'start' });
          });
        });
        window.addEventListener('scroll', function() {
          var fromTop = window.scrollY + 120;
          catSections.forEach(function(section, idx) {
            if (section.offsetTop <= fromTop && section.offsetTop + section.offsetHeight > fromTop) {
              navBtns.forEach(btn => btn.classList.remove('active'));
              navBtns[idx].classList.add('active');
            }
          });
        });
      });
    }
  </script>
</body>
</html>